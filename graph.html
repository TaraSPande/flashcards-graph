<!DOCTYPE html>
<html>
<head>
  <title>Flashcard Knowledge Graph</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }

    svg {
      flex: 2;
      border-right: 1px solid #ccc;
      background-color: #f9f9f9;
    }

    #info-panel {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
    }

    .node { cursor: pointer; stroke-width: 2px; }
    .node.highlighted { stroke: #000; stroke-width: 3px; }

    .label { pointer-events: none; font-size: 14px; }

    button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
    }

    h2, h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>

  <!-- Graph Canvas -->
  <svg id="graph" width="800" height="600"></svg>

  <!-- Info Panel -->
  <div id="info-panel">
    <h2>Flashcard Viewer</h2>
    <div id="qa-display">
      <p>Click on a node to see its question and answer.</p>
    </div>
    <button onclick="resetView()">üîÑ Reset View</button>
    <button onclick="location.href='index.html'">‚¨ÖÔ∏è Back to Home</button>
  </div>

  <script>
    const svg = d3.select("#graph");
    const container = svg.append("g");
    const width = +svg.attr("width");
    const height = +svg.attr("height");

    const zoom = d3.zoom()
      .scaleExtent([0.1, 4])
      .on("zoom", (event) => container.attr("transform", event.transform));

    svg.call(zoom);

    function resetView() {
      svg.transition()
        .duration(500)
        .call(zoom.transform, d3.zoomIdentity);
    }

    let selectedNode = null;

    fetch('flashcards.json')
      .then(response => response.json())
      .then(flashcards => {
        // If you want to color-code by subtopic later
        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const nodes = flashcards.map(card => ({
          id: card.id,
          question: card.question,
          answer: card.answer,
          subtopic: card.subtopic || "default"  // Optional: future color use
        }));

        const links = flashcards.flatMap(card =>
          card.links.map(targetId => ({ source: card.id, target: targetId }))
        );

        const simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(links).id(d => d.id).distance(150))
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2));

        const link = container.append("g")
          .attr("stroke", "#aaa")
          .selectAll("line")
          .data(links)
          .join("line");

        const node = container.append("g")
          .selectAll("circle")
          .data(nodes)
          .join("circle")
          .attr("r", 20)
          .attr("fill", d => color(d.subtopic))
          .attr("class", "node")
          .on("click", (_, d) => {
            d3.event?.stopPropagation(); // prevent background click from firing
            selectNode(d, d3.select(d3.event.currentTarget));
          });

        const label = container.append("g")
          .selectAll("text")
          .data(nodes)
          .join("text")
          .text(d => d.question)
          .attr("class", "label");

        function selectNode(d, nodeSelection) {
          // Remove highlight from previous node
          container.selectAll(".node").classed("highlighted", false);

          // Highlight current node
          nodeSelection.classed("highlighted", true);
          selectedNode = d;

          // Update the right panel
          document.getElementById("qa-display").innerHTML = `
            <h3>Question (ID: ${d.id})</h3>
            <p>${d.question}</p>
            <h3>Answer</h3>
            <p>${d.answer}</p>
          `;
        }

        function clearSelection() {
          container.selectAll(".node").classed("highlighted", false);
          selectedNode = null;
          document.getElementById("qa-display").innerHTML = `
            <p>Click on a node to see its question and answer.</p>
          `;
        }

        svg.on("click", () => {
          // Only clear selection if clicked outside a node
          clearSelection();
        });

        simulation.on("tick", () => {
          link
            .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
          node
            .attr("cx", d => d.x).attr("cy", d => d.y);
          label
            .attr("x", d => d.x + 25).attr("y", d => d.y);
        });
      });
  </script>

</body>
</html>
